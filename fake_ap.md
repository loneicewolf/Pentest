# Steps to create a controlled WiFi network 

#### Set wlan0 to monitor mode
```bash
ifconfig wlan0 down
iwconfig wlan0 mode monitor
ifconfig wlan0 up
```

#### Run hostapd with a hostapd.conf

Configuration:
```
interface=wlan0
driver=nl80211
ssid=ioactive2022
hw_mode=g
channel=11
macaddr_acl=0
ignore_broadcast_ssid=0
auth_algs=1
wpa=2
wpa_passphrase=ioactive2022
wpa_key_mgmt=WPA-PSK
wpa_pairwise=TKIP
rsn_pairwise=CCMP
wpa_group_rekey=86400
ieee80211n=1
wme_enabled=1
```



Commands:
```bash
sudo apt-get install hostapd
sudo hostapd hostapd.conf
```

#### Assign IP, netmask and define a route
```bash
ifconfig wlan0 up 192.168.137.1 netmask 255.255.255.0
route add -net 192.168.137.0 netmask 255.255.255.0 gw 192.168.137.1
```

#### Run dnsmasq

Configuration:
```
interface=wlan0
dhcp-range=192.168.137.2,192.168.137.30,255.255.255.0,12h
dhcp-option=3,192.168.137.1
dhcp-option=6,192.168.137.1
server=8.8.8.8
log-queries
log-dhcp
listen-address=127.0.0.1
```

Commands:
```bash
dnsmasq -C dnsmasq.conf -d
```

We also want to create a file fakehosts.conf to allow us to spoof certain DNS requests:
```
192.168.137.1 ioactive.com
```

This will cause the dnsmasq DNS server to respond with 192.168.137.1 to any request for ioactive.com.

We then need to bring dnsmasq up:

```bash
dnsmasq -C dnsmasq.conf -H fakehosts.conf -d
```

#### Forward Packets
```bash
sysctl -w net.ipv4.ip_forward=1
```


#### iptables configuration

```bash
iptables -F
iptables --delete-chain
iptables -t nat -F
iptables -t nat --delete-chain
iptables -P FORWARD ACCEPT
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
iptables -A FORWARD -i wlan0 -o eth0 -j ACCEPT
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.137.1:8080
iptables -t nat -A PREROUTING -p tcp --dport 443 -j DNAT --to-destination 192.168.137.1:8080

```



#### Monitor TCP connections

```bash
tcpdump -nn -i eth0  
```
